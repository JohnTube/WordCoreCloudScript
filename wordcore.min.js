var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},CustomEventCodes;(function(e){e[e.Undefined=0]="Undefined",e[e.InitGame=1]="InitGame",e[e.JoinGame=2]="JoinGame",e[e.WordukenUsed=3]="WordukenUsed",e[e.EndOfTurn=4]="EndOfTurn",e[e.EndOfRound=5]="EndOfRound",e[e.EndOfGame=6]="EndOfGame",e[e.NewRound=7]="NewRound",e[e.Resign=8]="Resign"})(CustomEventCodes||(CustomEventCodes={}));var GameTypes;(function(e){e[e.Undefined=0]="Undefined",e[e.Practice=1]="Practice",e[e.Random=2]="Random",e[e.Challenge=3]="Challenge"})(GameTypes||(GameTypes={}));var GameStates;(function(e){e[e.Undefined=0]="Undefined",e[e.MatchmakingTimedOut=1]="MatchmakingTimedOut",e[e.UnmatchedPlaying=2]="UnmatchedPlaying",e[e.UnmatchedWaiting=3]="UnmatchedWaiting",e[e.Playing=4]="Playing",e[e.P1Waiting=5]="P1Waiting",e[e.P2Waiting=6]="P2Waiting",e[e.Blocked=7]="Blocked",e[e.P1Resigned=8]="P1Resigned",e[e.P2Resigned=9]="P2Resigned",e[e.TimedOutDraw=10]="TimedOutDraw",e[e.TimedOutP1Won=11]="TimedOutP1Won",e[e.TimedOutP2Won=12]="TimedOutP2Won",e[e.EndedDraw=13]="EndedDraw",e[e.EndedP1Won=14]="EndedP1Won",e[e.EndedP2Won=15]="EndedP2Won"})(GameStates||(GameStates={}));var WordukenType;(function(e){e[e.NoWorduken=0]="NoWorduken",e[e.BestMove=1]="BestMove",e[e.WildCard=2]="WildCard",e[e.SingleColor=3]="SingleColor",e[e.Shuffler=4]="Shuffler",e[e.Incrementor=5]="Incrementor"})(WordukenType||(WordukenType={}));var GameLanguages;(function(e){e[e.Undefined=0]="Undefined",e[e.English=1]="English",e[e.French=2]="French"})(GameLanguages||(GameLanguages={}));var WebErrors;(function(e){e[e.Success=0]="Success",e[e.MissingArg=1]="MissingArg",e[e.UnexpectedValue=2]="UnexpectedValue",e[e.GameNotFound=5]="GameNotFound",e[e.MaxGamesReached=110]="MaxGamesReached",e[e.EventFailure=111]="EventFailure",e[e.UnknownError=100]="UnknownError",e[e.UserIdIssue=6]="UserIdIssue"})(WebErrors||(WebErrors={}));var maxRoundsPerGame=5,maxTurnsPerGame=3*maxRoundsPerGame,minAgeObsoleteGame=6e4,matchmakingTimeOut=60*minAgeObsoleteGame,roundTimeOut=48*matchmakingTimeOut,cleanUpTimeOut=2*roundTimeOut,maxSharedGroupKeysPerUpdate=5,maxGamesPerPlayer=5,ignoredUsers=["E5B98D6342BE2081","73BD7B8F4F332064","AE153C11A8A5AFBD","36FA5C73684CD689","8B962390A39AC3B0","982707EF02AE3898","3557776C7D92362E","56F1BEC55BF6D383","C5F4BDF9290B4D7B","D11CA9D40F20683F","1C2F249ED7F92165","DDD2FCBD209A4089","A87B7470F4AEDC76","6E4D79BFDB4710D6","34730C7340813EE2"],alphabets=[{A:1,B:3,C:3,D:2,E:1,F:4,G:2,H:4,I:1,J:8,K:5,L:1,M:3,N:1,O:1,P:3,Q:10,R:1,S:1,T:1,U:1,V:4,W:4,X:8,Y:4,Z:10},{A:1,B:3,C:3,D:2,E:1,F:4,G:2,H:4,I:1,J:8,K:10,L:1,M:2,N:1,O:1,P:3,Q:8,R:1,S:1,T:1,U:1,V:4,W:10,X:10,Y:10,Z:10}],storeProductIdPrefix="com.ThugLeaf.WordCoreAlpha.Worduken.",wordukensStoreIds=[storeProductIdPrefix+"BestMove",storeProductIdPrefix+"WildCard",storeProductIdPrefix+"SingleColor",storeProductIdPrefix+"Shuffler",storeProductIdPrefix+"Incrementor"],statsKeys={HI_SCORE_GAME:"HiScoreGame",HI_SCORE_MOVE:"HiScoreMove",MAX_LENGTH_MOVE:"MaxLengthMove",AVG_SCORE_MOVE:"AvgScoreMove",AVG_LENGTH_MOVE:"AvgLengthMove",HI_MULTIPLIER:"HiMultiplier"},userDataKeys={HI_SCORE_MOVE_WORD:"HiScoreMoveWord",LONGEST_WORD:"LongestWord"},leaveReason={ClientDisconnect:"0",ClientTimeoutDisconnect:"1",ManagedDisconnect:"2",ServerDisconnect:"3",TimeoutDisconnect:"4",ConnectTimeout:"5",SwitchRoom:"100",LeaveRequest:"101",PlayerTtlTimedOut:"102",PeerLastTouchTimedout:"103",PluginRequest:"104",PluginFailedJoin:"105"},unexpectedLeaveReasons=[leaveReason.ClientTimeoutDisconnect,leaveReason.ManagedDisconnect,leaveReason.ServerDisconnect,leaveReason.ConnectTimeout,leaveReason.TimeoutDisconnect,leaveReason.SwitchRoom,leaveReason.PlayerTtlTimedOut,leaveReason.PeerLastTouchTimedout,leaveReason.PluginRequest,leaveReason.PluginFailedJoin],PhotonLobbyType;(function(e){e[e.Default=0]="Default",e[e.SqlLobby=1]="SqlLobby",e[e.AsyncRandomLobby=2]="AsyncRandomLobby",e[e.SqlLobbyList=3]="SqlLobbyList"})(PhotonLobbyType||(PhotonLobbyType={}));var GameLogic=function(){function e(){}return e.getLengthBonus=function(e){try{var t=e.length,r=0;return t>4&&(r+=t-4),t>8&&(r+=t-8),t>12&&(r+=t-12),r}catch(e){throw e}},e.getMovePoints=function(e,t){try{var r=0,a=0,n=alphabets[e-1];for(r;r<t.length;r+=1){var s=t[r];a+=n[s]}return a}catch(e){throw e}},e.addMoveToGame=function(t,r,a){try{var n=r-1;0!==a.wt&&(t.a[n].w[a.wi].v=!0,a.wt===WordukenType.Incrementor&&(t.a[n].m+=1));var s=e.getMoveLetters(t,a);return a.lv=e.getMovePoints(t.l,s),a.lb=e.getLengthBonus(a.mw),a.mb=t.a[n].m,a.pb=t.a[n].p,a.lv>=a.pb&&(t.a[n].p=a.lv+1,a.pb>0&&(t.a[n].m+=1)),a.s=a.lv*t.a[n].m+a.lb,t.r[a.r].m[n]=a,t.a[n].s+=a.s,t}catch(e){throw e}},e.getMoveLetters=function(e,t){try{return t.mw}catch(e){throw e}},e.onInitGame=function(t,r){if(1!==t.ActorNr)throw new PhotonException(WebErrors.UnexpectedValue,"Custom InitGame event: Wrong ActorNr",{w:t,d:r});try{var a=t.Data;if(2!==a.gt&&3!==a.gt)throw new PhotonException(WebErrors.UnexpectedValue,"Custom InitGame event: Wrong GameType",{w:t,d:r});var n=[],s={};if(Utils.undefinedOrNull(a.w))n=[];else for(var o=0;o<a.w.length;o++)n[o]={t:-1,wt:a.w[o],wi:o,v:!1};for(var i=0;i<16;i++)s[String(i)]=a.r.gs[i];if(e.consumeWordukens(t.UserId,n,t.GameId),r={a:[{id:t.UserId,n:t.Nickname,p:0,s:0,m:1,w:n,ts:a.ts}],s:GameStates.UnmatchedPlaying,t:0,rg:t.Region,l:a.l,gt:a.gt,ts:a.ts},r.r=[{gs:s,ts:a.r.ts,r:0,m:[{},{}]}],ignoredUsers.indexOf(t.UserId)===-1){a.EvCode=CustomEventCodes.InitGame,a.GameId=t.GameId,a.Target="A87B7470F4AEDC76";var d="ENGLISH";2===r.l&&(d="FRENCH"),handlers.sendPushNotification({Recipient:"A87B7470F4AEDC76",Message:JSON.stringify({Message:t.Nickname+" created "+d+" game, v="+t.AppVersion,CustomData:a})}),a.Target="73BD7B8F4F332064",handlers.sendPushNotification({Recipient:"73BD7B8F4F332064",Message:JSON.stringify({Message:t.Nickname+" created "+d+" game, v="+t.AppVersion,CustomData:a})})}return r.gt===GameTypes.Challenge&&(a.EvCode=CustomEventCodes.InitGame,a.Target=a.OpponentId,a.GameId=t.GameId,r.a[1]={id:a.OpponentId,w:[]},handlers.sendPushNotification({Recipient:a.OpponentId,Message:JSON.stringify({Message:t.Nickname+" challenged you to a game !",CustomData:a})}),Utils.updateSharedGroupEntry(Helpers.getGamesListId(a.OpponentId),t.GameId,{})),r}catch(e){throw e}},e.onJoinGame=function(t,r){if(2!==t.ActorNr||1!==r.a.length&&r.gt!==GameTypes.Challenge)throw new PhotonException(WebErrors.EventFailure,"Custom JoinGame event: Wrong actorNr or duplicate event",{w:t,d:r});try{if(r.s===GameStates.UnmatchedPlaying&&0===r.t)r.s=GameStates.Playing;else{if(r.s!==GameStates.UnmatchedWaiting||1!==r.t)throw new PhotonException(WebErrors.EventFailure,"Custom JoinGame event: unexpected Ss,Ts",{w:t,d:r});r.s=GameStates.P1Waiting}r.gt===GameTypes.Random&&Utils.updateSharedGroupEntry(Helpers.getGamesListId(t.UserId),t.GameId,{});var a=t.Data,n=[];if(Utils.undefinedOrNull(a.w))n=[];else for(var s=0;s<a.w.length;s++)n[s]={t:-1,wt:a.w[s],wi:s,v:!1};if(e.consumeWordukens(t.UserId,n,t.GameId),r.a[1]={id:t.UserId,n:t.Nickname,p:0,s:0,m:1,w:n,ts:a.ts},r.r[0].ts=a.ts,!Utils.undefinedOrNull(t.State))for(var s=0;s<t.State.ActorList.length;s++)if(t.State.ActorList[s].UserId===r.a[2-t.ActorNr].id&&t.State.ActorList[s].IsActive===!0)return r;return a.GameId=t.GameId,a.EvCode=CustomEventCodes.JoinGame,a.n=t.Nickname,a.Target=r.a[0].id,r.gt===GameTypes.Challenge?handlers.sendPushNotification({Recipient:r.a[0].id,Message:JSON.stringify({Message:t.Nickname+" accepted your challenge!",CustomData:a})}):handlers.sendPushNotification({Recipient:r.a[0].id,Message:JSON.stringify({Message:t.Nickname+" has joined a game!",CustomData:a})}),r}catch(e){throw e}},e.onWordukenUsed=function(e,t){try{var r=e.Data;return t.a[e.ActorNr-1].w[r.wi]=r,t}catch(e){throw e}},e.onEndOfTurn=function(t,r){if(t.Data.t%3!==t.ActorNr||t.Data.t<1||t.Data.t>=maxTurnsPerGame)throw new PhotonException(WebErrors.EventFailure,"Custom EndOfTurn event: wrong t#",{w:t,d:r});try{var a=t.Data,n=r.r.length-1,s=a.r;if(1===t.ActorNr&&1===a.t&&r.s===GameStates.UnmatchedPlaying)r.s=GameStates.UnmatchedWaiting;else if(r.s===GameStates.Playing&&a.t===r.t+t.ActorNr)r.s=GameStates.Playing+t.ActorNr;else{if(n!==s||r.t+a.t!==3*(2*n+1)){if(!Utils.undefinedOrNull(r.r[s])){var o=r.r[s].m[t.ActorNr-1];if(o.mw===a.mw&&o.ts===a.ts&&o.t===a.t&&o.wt===a.wt)return r}throw new PhotonException(WebErrors.EventFailure,"Unexpected GameState ("+r.s+") in EndOfTurn, GameId="+t.GameId,{w:t,d:r})}if(Utils.logException("Concurrency issue, GameId="+t.GameId,{w:t,d:r}),n===maxRoundsPerGame-1)return t.Data.SkipBlocked=!0,t.EvCode=CustomEventCodes.EndOfGame,e.onEndOfGame(t,r);r.s=GameStates.Blocked}return r=e.addMoveToGame(r,t.ActorNr,a),r.t+=t.ActorNr,e.addToEventsCache(t,r)}catch(e){throw e}},e.onEndOfRound=function(t,r){try{var a=t.Data;if(a.m.t%3!==0||a.m.t<3||a.m.t>maxTurnsPerGame||a.m.t!==r.t+t.ActorNr)throw new PhotonException(WebErrors.EventFailure,"Custom EndOfRound event: wrong t#",{w:t,d:r});if(a.r.r!==r.r.length)throw new PhotonException(WebErrors.EventFailure,"Custom EndOfRound event: wrong r#",{w:t,d:r});if(r.s!==GameStates.Playing+(3-t.ActorNr))throw new PhotonException(WebErrors.EventFailure,"Custom EndOfRound event: wrong s",{w:t,d:r});r=e.addMoveToGame(r,t.ActorNr,a.m);var n=a.r.r;if(r.r[n]={r:a.r.r,gs:a.r.gs,ts:a.r.ts,m:[{},{}]},r.t=3*a.r.r,r.s=GameStates.Playing,!Utils.undefinedOrNull(t.State))for(var s=0;s<t.State.ActorList.length;s++)if(t.State.ActorList[s].UserId===r.a[2-t.ActorNr].id&&t.State.ActorList[s].IsActive===!0)return e.addToEventsCache(t,r);return a.GameId=t.GameId,a.EvCode=CustomEventCodes.EndOfRound,a.Target=r.a[2-t.ActorNr].id,handlers.sendPushNotification({Recipient:r.a[2-t.ActorNr].id,Message:JSON.stringify({Message:t.Nickname+" has played "+a.m.mw,CustomData:a})}),e.addToEventsCache(t,r)}catch(e){throw e}},e.onEndOfGame=function(t,r){try{var a=t.Data;if(a.SkipBlocked!==!0&&a.t!==maxTurnsPerGame||a.t!==r.t+t.ActorNr)throw new PhotonException(WebErrors.EventFailure,"Custom EndOfGame event: wrong t#",{w:t,d:r});if(r.s!==GameStates.Playing+(3-t.ActorNr))throw new PhotonException(WebErrors.EventFailure,"Custom EndOfGame event: wrong s",{w:t,d:r});if(r.r.length!==maxRoundsPerGame)throw new PhotonException(WebErrors.EventFailure,"Custom EndOfGame event: wrong r#",{w:t,d:r});r=e.addMoveToGame(r,t.ActorNr,a),r.t=maxTurnsPerGame,r.a[0].s===r.a[1].s?r.s=GameStates.EndedDraw:r.a[0].s>r.a[1].s?r.s=GameStates.EndedP1Won:r.s=GameStates.EndedP2Won,r.deletionFlag=t.ActorNr,e.redeemWordukens(t.UserId,r.a[t.ActorNr-1].w,t.GameId),e.updateGameOverStats(t.ActorNr,r);var n=". Game has ended, ";if(n+=r.s===GameStates.EndedDraw?"Tie!":r.s===GameStates.EndedDraw+t.ActorNr?"You lost!":"You won!",!Utils.undefinedOrNull(t.State))for(var s=0;s<t.State.ActorList.length;s++)if(t.State.ActorList[s].UserId===r.a[2-t.ActorNr].id&&t.State.ActorList[s].IsActive===!0)return e.addToEventsCache(t,r);return a.GameId=t.GameId,a.EvCode=CustomEventCodes.EndOfGame,a.Target=r.a[2-t.ActorNr].id,handlers.sendPushNotification({Recipient:r.a[2-t.ActorNr].id,Message:JSON.stringify({Message:t.Nickname+" has played "+a.mw+n,CustomData:a})}),e.addToEventsCache(t,r)}catch(e){throw e}},e.onNewRound=function(e,t){if(t.s!==GameStates.Blocked)return Utils.logException("Unexpected GameState onNewRound (probably 2nd client tried to fix blocked round too late)",{w:e,d:t}),t;try{var r=e.Data,a=r.r;if(t.r[a]={r:r.r,gs:r.gs,ts:r.ts,m:[{},{}]},t.s=GameStates.Playing,t.Cache[t.Cache.length-1][1]!==CustomEventCodes.EndOfTurn,t.Cache[t.Cache.length-1][1]=CustomEventCodes.EndOfRound,t.Cache[t.Cache.length-1][2]=t.t,!Utils.undefinedOrNull(e.State))for(var n=0;n<e.State.ActorList.length;n++)e.State.ActorList[n].IsActive===!1&&(r.EvCode=CustomEventCodes.NewRound,r.Target=e.State.ActorList[n].UserId,r.GameId=e.GameId,handlers.sendPushNotification({Recipient:e.State.ActorList[n].UserId,Message:JSON.stringify({Message:e.Nickname+" has played "+t.Cache[t.Cache.length-1][2].m.mw,CustomData:r})}));return t}catch(e){throw e}},e.onResign=function(t,r){var a=1;if(t.UserId!==Helpers.getCreatorId(t.GameId)&&(a=2,2!==r.a.length))throw new PhotonException(WebErrors.EventFailure,"Cannot resign: Wrong Player ("+a+"):"+t.UserId+" not found!",{w:t,d:r});if(r.a[a-1].id!==t.UserId)throw new PhotonException(WebErrors.EventFailure,"Cannot resign: Wrong Player ("+a+"):"+t.UserId+" != saved:"+r.a[a-1].id,{w:t,d:r});if(r.s<=GameStates.MatchmakingTimedOut||r.s>=GameStates.P1Resigned)throw new PhotonException(WebErrors.EventFailure,"Cannot resign: Game is over already, state="+r.s,{w:t,d:r});if(r.s=GameStates.Blocked+a,r.deletionFlag=a,e.redeemWordukens(t.UserId,r.a[a-1].w,t.GameId),e.updateGameOverStats(a,r),2===r.a.length){var n=r.a[a-1].n+" resigned!";2===a&&3===r.gt&&r.s<GameStates.Playing&&(n=r.a[a-1].n+" declined the challenge!"),handlers.sendPushNotification({Recipient:r.a[2-a].id,Message:JSON.stringify({Message:n,CustomData:{EvCode:CustomEventCodes.Resign,GameId:t.GameId,Target:r.a[2-a].id}})})}return r},e.addToEventsCache=function(e,t){try{t.hasOwnProperty("Cache")||(t.Cache=[]);var r=void 0;switch(e.EvCode){case CustomEventCodes.EndOfTurn:case CustomEventCodes.EndOfGame:r=e.Data.t;break;case CustomEventCodes.EndOfRound:r=e.Data.m.t;break;default:throw new PhotonException(WebErrors.EventFailure,"Trying to cache unhandled event",{w:e,d:t})}for(var a=0;a<t.Cache.length;a++){var n=t.Cache[a];if(n[2]===r)throw new PhotonException(WebErrors.EventFailure,"Trying to cache duplicate event",{w:e,d:t})}var s=[e.ActorNr,e.EvCode,r];return t.Cache.push(s),t}catch(e){throw e}},e.onEventReceived=function(t,r){if(t.ActorNr<1||t.ActorNr>2)throw new PhotonException(WebErrors.EventFailure,"Unexpected ActorNr ="+t.ActorNr,{w:t,d:r});try{switch(t.EvCode){case CustomEventCodes.InitGame:return e.onInitGame(t,r);case CustomEventCodes.JoinGame:return e.onJoinGame(t,r);case CustomEventCodes.WordukenUsed:return e.onWordukenUsed(t,r);case CustomEventCodes.EndOfTurn:return e.onEndOfTurn(t,r);case CustomEventCodes.EndOfRound:return e.onEndOfRound(t,r);case CustomEventCodes.EndOfGame:return e.onEndOfGame(t,r);case CustomEventCodes.NewRound:return e.onNewRound(t,r);case CustomEventCodes.Resign:return e.onResign(t,r);default:return r}}catch(e){throw e}},e.consumeWordukens=function(e,t,r){try{for(var a={},n="",s=0;s<t.length;s++)t[s].wt!==WordukenType.Shuffler&&(n=wordukensStoreIds[t[s].wt-1],Utils.undefinedOrNull(a[n])?a[n]=1:a[n]=a[n]+1);var o=Utils.getUserInventory(e);for(n in a)if(a.hasOwnProperty(n)){for(var i=null,d=0;d<o.length;d++)if(o[d].ItemId===n){if(!Utils.undefinedOrNull(i))return void Utils.logException("Unexpected:ItemId "+n+" not unique in inventory",{i:o,e:a,w:t});if(!(o[d].RemainingUses>=a[n]))return void Utils.logException("Unexpected:Number of item"+n+" not allowed"+r,{i:o,e:a,w:t});i=o[d].ItemInstanceId}if(Utils.undefinedOrNull(i))return void Utils.logException("Unexpected:ItemId "+n+" not found",{i:o,e:a,w:t});Utils.consumeItem(e,i,a[n])}}catch(a){Utils.logException("Unexpected:consumeWordukens exception",{err:a,w:t,u:e,g:r})}},e.redeemWordukens=function(e,t,r){try{for(var a=[],n=0;n<t.length;n++)t[n].t===-1&&t[n].wt!==WordukenType.Shuffler&&a.push(wordukensStoreIds[t[n].wt-1]);a.length>0&&Utils.grantItemsToUser(e,a)}catch(a){Utils.logException("Unexpected:redeemWordukens exception",{err:a,w:t,u:e,g:r})}},e.updateGameOverStats=function(t,r){try{var a=r.a[t-1],n=Utils.getPlayerCombinedInfo(a.id),s={},o={},i=[],d={},l=void 0,u=void 0;if(!Utils.undefinedOrNull(n.PlayerStatistics))for(l=0;l<n.PlayerStatistics.length;l++)u=n.PlayerStatistics[l].StatisticName,s[u]=n.PlayerStatistics[u].Value;if(!Utils.undefinedOrNull(n.UserReadOnlyData))for(u in n.UserReadOnlyData)n.UserReadOnlyData.hasOwnProperty(u)&&(o[u]=n.UserReadOnlyData[u].Value);var c=s[statsKeys.HI_SCORE_GAME];(Utils.undefinedOrNull(c)||c<a.s)&&i.push({StatisticName:statsKeys.HI_SCORE_GAME,Value:a.s}),c=s[statsKeys.HI_MULTIPLIER],(Utils.undefinedOrNull(c)||c<a.m)&&i.push({StatisticName:statsKeys.HI_MULTIPLIER,Value:a.m});var m=0,g="",h=0,f="",p=0,E=0,v=0;for(l=0;l<r.r.length;l++){var G=r.r[l].m[t-1];if(Utils.isEmpty(G))break;p++;var y=e.getMoveLetters(r,G),U=e.getMovePoints(r.l,y);v+=U,U>=m&&(m=U,g=G.mw);var O=G.mw.length;E+=O,O>=h&&(h=O,f=G.mw)}p===maxRoundsPerGame?(E=Math.floor(E/p),v=Math.floor(v/p)):(E=0,v=0),c=s[statsKeys.AVG_SCORE_MOVE],(Utils.undefinedOrNull(c)||c<h)&&i.push({StatisticName:statsKeys.AVG_SCORE_MOVE,Value:v}),c=s[statsKeys.AVG_LENGTH_MOVE],(Utils.undefinedOrNull(c)||c<h)&&i.push({StatisticName:statsKeys.AVG_LENGTH_MOVE,Value:E}),c=s[statsKeys.HI_SCORE_MOVE],(Utils.undefinedOrNull(c)||c<=m)&&(i.push({StatisticName:statsKeys.HI_SCORE_MOVE,Value:m}),d[userDataKeys.HI_SCORE_MOVE_WORD]=g),c=s[statsKeys.MAX_LENGTH_MOVE],(Utils.undefinedOrNull(c)||c<=h)&&(i.push({StatisticName:statsKeys.MAX_LENGTH_MOVE,Value:h}),d[userDataKeys.LONGEST_WORD]=f),i.length>0&&Utils.updatePlayerStats(a.id,i),Utils.isEmpty(d)||Utils.updateUserReadOnlyData(a.id,d)}catch(e){Utils.logException("updatePlayerStats error",{err:e,a:t,g:r})}},e}();handlers.onLogin=function(e){return handlers.pollData(e)},handlers.pollData=function(e){try{Utils.undefinedOrNull(e.UserId)&&(e.UserId=currentPlayerId);var t=Helpers.getPollResponse(e.g,e.UserId);return{ResultCode:WebErrors.Success,Data:t}}catch(t){return Utils.logException("pollData",{err:t,args:e}),{ResultCode:WebErrors.UnknownError}}},handlers.deleteGames=function(e){try{Utils.undefinedOrNull(e.UserId)&&(e.UserId=currentPlayerId);var t=e.g;return Helpers.deleteOrFlagGames(t,e.UserId),{ResultCode:WebErrors.Success}}catch(t){return Utils.logException("deleteGames",{e:t,args:e}),{ResultCode:WebErrors.UnknownError}}},handlers.resign=function(e){try{Utils.undefinedOrNull(e.UserId)&&(e.UserId=currentPlayerId);var t=Helpers.loadGameData(e.GameId);return Utils.undefinedOrNull(t)?{ResultCode:WebErrors.GameNotFound,Data:{GameId:e.GameId},Message:"Cannot resign: game not found"}:(GameLogic.onResign(e,t),Helpers.saveGameData(e.GameId,t),{ResultCode:WebErrors.Success,Data:{GameId:e.GameId}})}catch(t){return Utils.logException("resign",{e:t,args:e}),{ResultCode:WebErrors.UnknownError,Data:{GameId:e.GameId},Message:"Cannot resign: Unknown error!"}}},handlers.fixRound=function(e){try{Utils.undefinedOrNull(e.UserId)&&(e.UserId=currentPlayerId);var t=Helpers.loadGameData(e.GameId);return GameLogic.onNewRound(e,t),Helpers.saveGameData(e.GameId,t),{ResultCode:WebErrors.Success,Data:{GameId:e.GameId,r:t.Cache[t.Cache.length-1][2]}}}catch(t){return Utils.logException("fixRound",{e:t,args:e}),{ResultCode:WebErrors.UnknownError}}},handlers.onPlayerCreated=function(e,t){try{Utils.createSharedGroup(Helpers.getGamesListId(currentPlayerId)),handlers.sendPushNotification({Recipient:"A87B7470F4AEDC76",Message:JSON.stringify({Message:"A new player ("+currentPlayerId+") is created."})}),handlers.sendPushNotification({Recipient:"73BD7B8F4F332064",Message:JSON.stringify({Message:"A new player ("+currentPlayerId+") is created."})})}catch(r){return Utils.logException("onPlayerCreated",{e:r,args:e,context:t}),{ResultCode:WebErrors.UnknownError}}},handlers.sendPushNotification=function(e){var t;try{return t=server.SendPushNotification(e)}catch(r){if("PushNotEnabledForAccount"===r.Error.error)return;Utils.logException("error in sendPushNotification",{a:e,e:r,r:t})}};var PhotonException=function(e){function t(t,r,a){var n=e.call(this,r)||this;return n.resultCode=t,n.message=r,n.timestamp=Utils.getISOTimestamp(),n.data=a,Utils.logException(r,a,n.timestamp),n}return __extends(t,e),t}(Error),Helpers=function(){function e(){}return e.getGamesListId=function(e){if(Utils.undefinedOrNull(e))throw new PhotonException(WebErrors.UserIdIssue,"getGamesListId: playerId is Utils.Utils.undefinedOrNull",null);return e+"_GamesList"},e.getCreatorId=function(e){return Utils.undefinedOrNull(e)?e:e.split("-")[4]},e.isGameOver=function(e){if(Utils.undefinedOrNull(e)||Utils.undefinedOrNull(e.s))throw new PhotonException(WebErrors.UnexpectedValue,"gameData or gameData.s is Utils.Utils.undefinedOrNull",e);switch(e.s){case GameStates.Undefined:throw new PhotonException(WebErrors.UnexpectedValue,"GameState is Undefined",e);case GameStates.Playing:case GameStates.P1Waiting:case GameStates.P2Waiting:case GameStates.Blocked:return!1;default:return!0}},e.loadGameData=function(t){var r;try{if(r=Utils.getSharedGroupEntry(e.getGamesListId(e.getCreatorId(t)),t),!Utils.undefinedOrNull(r)&&!Utils.undefinedOrNull(r.State)){if(r.State.ActorList.length!==r.a.length&&r.gt!==GameTypes.Challenge)throw new PhotonException(WebErrors.UnexpectedValue,"State.ActorList.length != a.length",r);r.State.EmptyRoomTTL=0,r.State.PlayerTTL=-1,r.State.PublishUserId=!0,r.State.MaxPlayers=2,r.State.Slice=0,r.State.DeleteCacheOnLeave=!1,r.State.SuppressRoomEvents=!0,r.State.CheckUserOnJoin=!0,2===r.gt?r.State.LobbyType=3:3===r.gt&&(r.State.LobbyType=0),r.State.ActorCounter=r.State.ActorList.length,r.State.ActorList[0].ActorNr=1,r.State.ActorList[0].UserId=r.a[0].id,2===r.State.ActorList.length&&(r.State.ActorList[1].ActorNr=2,r.State.ActorList[1].UserId=r.a[1].id)}return r}catch(e){throw Utils.logException("loadGameData:"+t+", currentPlayerId="+currentPlayerId,{err:e,ret:r}),e}},e.saveGameData=function(t,r){try{delete r.pn,Utils.updateSharedGroupEntry(e.getGamesListId(e.getCreatorId(t)),t,r)}catch(e){throw Utils.logException("error saving GameId:"+t,{error:e,d:r}),e}},e.stripRoomState=function(e){delete e.DebugInfo,delete e.CustomProperties,delete e.EmptyRoomTTL,delete e.PlayerTTL,delete e.PublishUserId,delete e.MaxPlayers,delete e.ExcludedActors,delete e.ExpectedUsers,delete e.Slice,delete e.DeleteCacheOnLeave,delete e.SuppressRoomEvents,delete e.LobbyProperties,delete e.CheckUserOnJoin,delete e.Binary[20],delete e.LobbyType,delete e.ActorCounter;for(var t=0,r=e.ActorList;t<r.length;t++){var a=r[t];delete a.DEBUG_BINARY,delete a.Nickname,delete a.ActorNr,delete a.UserId,delete a.IsActive}return e},e.checkTimeOut=function(e,t){return Utils.undefinedOrNull(e)||Utils.undefinedOrNull(t)?(Utils.logException("timestamp Utils.undefinedOrNull "+t),!1):(e.includes(".")||(e=e.substr(0,e.lastIndexOf(":"))+"."+e.substr(e.lastIndexOf(":")+1)),Date.now()-new Date(e).getTime()>t)},e.checkRoundTimeOut=function(e){return this.checkTimeOut(e,roundTimeOut)},e.checkMatchmakingTimeOut=function(e){return this.checkTimeOut(e,matchmakingTimeOut)},e.checkLeftOversTimeOut=function(e){return this.checkTimeOut(e,cleanUpTimeOut)},e.getPollResponse=function(t,r){try{var a=e.pollGamesData(t,r),n=void 0,s=void 0,o=void 0,i=void 0,d={};if(!Utils.undefinedOrNull(a)){Utils.isEmpty(a.a)||(d.a=a.a),i=Utils.undefinedOrNull(a.d)?{}:a.d;for(n in i)if(i.hasOwnProperty(n))if(s=i[n],Utils.undefinedOrNull(t)||!t.hasOwnProperty(n))s.s<GameStates.P1Resigned&&s.s>GameStates.MatchmakingTimedOut&&(delete s.State,delete s.Cache,d.hasOwnProperty("n")||(d.n={}),d.n[n]=s);else if(o=t[n],o.ignoreUpdate!==!0){if(o.t!==s.t||o.s!==s.s){var l=e.getDiffData(s,o);Utils.undefinedOrNull(l)?(Utils.logException("(Tc="+o.t+",Sc="+o.s+") > (Ts="+s.t+",Ss="+s.s+"), GameId="+n,{s:s,c:o}),d.hasOwnProperty("m")||(d.m={}),d.m[n]={t:s.t,s:s.s}):(d.hasOwnProperty("u")||(d.u={}),d.u[n]=l)}}else Utils.logException("Skip checking update for GameId="+n,{s:s,c:o});if(!Utils.isEmpty(t))for(n in t)if(t.hasOwnProperty(n)&&!i.hasOwnProperty(n)){var u=n.split("-")[1];e.checkTimeOut(u,minAgeObsoleteGame)&&(d.hasOwnProperty("o")||(d.o=[]),d.o.push(n))}}return d}catch(e){throw e}},e.pollGamesData=function(t,r){try{var a={},n=e.getGamesListId(r),s={},o={},i=void 0,d=void 0,l={},u={};a=Utils.getSharedGroupData(n),o[n]={};for(i in a)if(a.hasOwnProperty(i))if(d=e.getCreatorId(i),d===r){Utils.undefinedOrNull(t)||!t.hasOwnProperty(i)||Utils.undefinedOrNull(t[i].e)||(u[i]=e.addMissingEvents(t[i],a[i]),(u[i].length>1||1===u[i].length&&u[i][0][0]===!0)&&(o[n][i]=a[i]));var c=a[i].ts;if(a[i].s===GameStates.UnmatchedPlaying||a[i].s===GameStates.UnmatchedWaiting)Utils.undefinedOrNull(c)?Utils.logException("Utils.undefinedOrNull timestamp of game creation",a[i]):e.checkMatchmakingTimeOut(c)&&(a[i].s=GameStates.MatchmakingTimedOut,GameLogic.redeemWordukens(r,a[i].a[0].w,i),o[n][i]=a[i]);else if(e.isGameOver(a[i])===!1){var m=a[i].r.length-1;if(c=a[i].r[m].ts,Utils.undefinedOrNull(c))Utils.logException("Utils.undefinedOrNull timestamp of last round="+m,a[i]);else if(e.checkRoundTimeOut(c)){var g=a[i].t%3;a[i].s=GameStates.TimedOutDraw+g,a[i].s===GameStates.TimedOutDraw&&(a[i].a[0].s>a[i].a[1].s?a[i].s=GameStates.TimedOutP1Won:a[i].a[0].s<a[i].a[1].s&&(a[i].s=GameStates.TimedOutP2Won)),o[n][i]=a[i]}}e.checkLeftOversTimeOut(c)?(Utils.logException("Deleting leftover game "+i,a[i]),o[n][i]=null):!Utils.undefinedOrNull(a[i].a)&&a[i].a.length>=1&&a[i].a[0].id===r?(l[i]=a[i],l[i].pn=1):(o[n][i]=null,Utils.logException("actors array is missing or corrupt",a[i]))}else s.hasOwnProperty(d)||(s[d]=[]),s[d].push(i);for(d in s)if(s.hasOwnProperty(d)){n=e.getGamesListId(d),o[n]={},a=Utils.getSharedGroupData(n,s[d]);for(var h=0;h<s[d].length;h++)if(i=s[d][h],a.hasOwnProperty(i)){Utils.undefinedOrNull(t)||!t.hasOwnProperty(i)||Utils.undefinedOrNull(t[i].e)||(u[i]=e.addMissingEvents(t[i],a[i]),(u[i].length>1||1===u[i].length&&u[i][0][0]===!0)&&(o[n][i]=a[i]));var m=a[i].r.length-1,c=a[i].r[m].ts;if(a[i].s<GameStates.Playing&&2===a[i].gt)Utils.logException("Unexpected GameState ("+a[i].s+") of game "+i+" referenced from "+r,a[i]);else if(e.isGameOver(a[i])===!1)if(Utils.undefinedOrNull(c))Utils.logException("Utils.undefinedOrNull timestamp of last round="+m,a[i]);else if(e.checkRoundTimeOut(c)){var g=a[i].t%3;a[i].s=GameStates.TimedOutDraw+g,a[i].s===GameStates.TimedOutDraw&&(a[i].a[0].s>a[i].a[1].s?a[i].s=GameStates.TimedOutP1Won:a[i].a[0].s<a[i].a[1].s&&(a[i].s=GameStates.TimedOutP2Won)),o[n][i]=a[i]}e.checkLeftOversTimeOut(c)?(Utils.logException("Deleting leftover game "+i,a[i]),o[n][i]=null):Utils.undefinedOrNull(a[i].a)||2!==a[i].a.length||a[i].a[0].id!==d||a[i].a[1].id!==r?(o[n][i]=null,Utils.logException("actors array is missing or corrupt",a[i])):(l[i]=a[i],l[i].pn=2)}else s[d].includes(i)?(o[e.getGamesListId(r)][i]=null,Utils.logException("pollGamesData, "+i+" save was not found, referenced from "+r)):Utils.logException("game "+i+" from gamesList of user="+d,{GameList:a,ListToLoad:s[d]})}for(n in o)o.hasOwnProperty(n)&&!Utils.isEmpty(o[n])&&Utils.updateSharedGroupData(n,o[n]);return{d:l,a:u}}catch(e){throw e}},e.getDiffData=function(e,t){var r;try{if(e.s!==t.s)switch(t.s){case GameStates.UnmatchedPlaying:if(e.s===GameStates.UnmatchedWaiting)break;if(e.s===GameStates.MatchmakingTimedOut||e.s===GameStates.P1Resigned)r.s=e.s;else{if(!(e.s>=GameStates.Playing&&2===e.a.length))return Utils.logException("getDiff:Unexpected client state",{c:t,s:e}),null;for(var a=[],n=0;n<e.a[1].w.length;n++)a.push(e.a[1].w[n].wt);r.e=[[2,CustomEventCodes.JoinGame,{id:e.a[1].id,n:e.a[1].n,w:a,ts:e.a[1].ts}]]}break;case GameStates.UnmatchedWaiting:if(e.s===GameStates.MatchmakingTimedOut)r.s=e.s;else if(e.s>=GameStates.Playing&&2===e.a.length){for(var a=[],n=0;n<e.a[1].w.length;n++)a.push(e.a[1].w[n].wt);r.e=[[2,CustomEventCodes.JoinGame,{id:e.a[1].id,n:e.a[1].n,w:a,ts:e.a[1].ts}]]}else r=null;break;case GameStates.Playing:case GameStates.P1Waiting:case GameStates.P2Waiting:case GameStates.Blocked:if(e.s<GameStates.Playing)return Utils.logException("getDiff:Unexpected client state",{c:t,s:e}),null;e.s>=GameStates.TimedOutDraw&&e.s<=GameStates.TimedOutP2Won&&(r.s=e.s);break;default:return Utils.logException("getDiff:Unexpected client state",{c:t,s:e}),null}var s=Math.floor(t.t/3);if(e.t===t.t&&t.t===3*s&&t.s===GameStates.Blocked)Utils.isEmpty(r.e)&&(r.e=[]),r.e.push([0,CustomEventCodes.NewRound,{gs:e.r[s].gs,r:e.r[s].r,ts:e.r[s].ts}]);else if(!Utils.isEmpty(e.Cache)&&e.t>t.t){s*=2,t.s===GameStates.Blocked&&s--;for(var o=s;o<e.Cache.length;o++){var i=e.Cache[o];switch(i[1]){case CustomEventCodes.EndOfGame:Utils.isEmpty(r.e)&&(r.e=[]),r.e.push([i[0],i[1],e.r[e.r.length-1].m[i[0]-1]]);break;case CustomEventCodes.EndOfTurn:var d=Math.floor(i[2]/3);(t.t<i[2]||d===s&&t.t!==i[2])&&(Utils.isEmpty(r.e)&&(r.e=[]),r.e.push([i[0],i[1],e.r[d].m[i[0]-1]]));break;case CustomEventCodes.EndOfRound:d=Math.floor(i[2]/3),t.t<i[2]?(Utils.isEmpty(r.e)&&(r.e=[]),r.e.push([i[0],i[1],{r:{gs:e.r[d].gs,r:e.r[d].r,ts:e.r[d].ts},m:e.r[d-1].m[i[0]-1]}])):t.t===i[2]&&t.s===GameStates.Blocked&&(Utils.isEmpty(r.e)&&(r.e=[]),r.e.push([0,CustomEventCodes.NewRound,{gs:e.r[d].gs,r:e.r[d].r,ts:e.r[d].ts}]))}}e.s===GameStates.P1Resigned?(Utils.isEmpty(r.e)&&(r.e=[]),r.e.push([1,CustomEventCodes.Resign,{}])):e.s===GameStates.P2Resigned&&(Utils.isEmpty(r.e)&&(r.e=[]),r.e.push([2,CustomEventCodes.Resign,{}]))}return r}catch(a){throw Utils.logException("getDiffError",{d:r,c:t,s:e,err:a}),a}},e.deleteOrFlagGames=function(t,r){try{var a=void 0,n=void 0,s=void 0,o=e.getGamesListId(r),i={},d={},l=Utils.getSharedGroupData(o,t);d[o]={};for(a in l)if(l.hasOwnProperty(a))if(s=l[a],n=e.getCreatorId(a),n===r){if(!e.isGameOver(s)){Utils.logException("trying to flag/delete a game ("+a+") that is not over, user "+r,s);continue}1===s.deletionFlag?Utils.logException("game: "+a+" already flagged (1) for user: "+r,s):2===s.deletionFlag||s.gt===GameTypes.Random&&1===s.a.length?(GameLogic.redeemWordukens(r,s.a[0].w,a),GameLogic.updateGameOverStats(1,s),d[o][a]=null):(GameLogic.redeemWordukens(r,s.a[0].w,a),GameLogic.updateGameOverStats(1,s),s.deletionFlag=1,d[o][a]=s)}else i.hasOwnProperty(n)||(i[n]=[]),i[n].push(a),d[o][a]=null;for(n in i)if(i.hasOwnProperty(n)){o=e.getGamesListId(n),d[o]={},l=Utils.getSharedGroupData(o,i[n]);for(var u=0;u<i[n].length;u++)if(a=i[n][u],l.hasOwnProperty(a)){if(s=l[a],!e.isGameOver(s)){Utils.logException("trying to flag/delete a game ("+a+") that is not over, user "+n,s);continue}2===s.deletionFlag?Utils.logException("game: "+a+" already flagged (2) for user: "+r,s):1===s.deletionFlag?(GameLogic.redeemWordukens(r,s.a[1].w,a),GameLogic.updateGameOverStats(2,s),d[o][a]=null):(GameLogic.redeemWordukens(r,s.a[1].w,a),GameLogic.updateGameOverStats(2,s),s.deletionFlag=2,d[o][a]=s)}else i[n].includes(a)&&(d[e.getGamesListId(r)][a]=null,Utils.logException("deleteOrFlagGames, "+a+" save was not found, referenced from "+r))}for(o in d)d.hasOwnProperty(o)&&!Utils.isEmpty(d[o])&&Utils.updateSharedGroupData(o,d[o])}catch(e){throw e}},e.addMissingEvents=function(e,t){try{if(Utils.undefinedOrNull(e)||Utils.isEmpty(e.e))return;for(var r=e.e,a=[],n=0;n<r.length;n++){var s=r[n],o=[!0,s.EvCode];switch(s.EvCode){case CustomEventCodes.EndOfRound:o.push(s.Data.r.r);break;case CustomEventCodes.NewRound:o.push(s.Data.r);break;case CustomEventCodes.EndOfGame:case CustomEventCodes.EndOfTurn:o.push(s.Data.t);break;case CustomEventCodes.WordukenUsed:o.push(s.Data.wi)}try{t=GameLogic.onEventReceived(s,t)}catch(t){if(!(t instanceof PhotonException&&t.resultCode===WebErrors.EventFailure))return Utils.logException("addMissingEvents UNHANDLED onEventReceived error",t),e.ignoreUpdate=!0,a;o[0]=!1,e.ignoreUpdate=!0}if(a.push(o),o[0]===!1)return a}return a}catch(e){Utils.logException("addMissingEvents error",e)}},e}();handlers.RoomCreated=function(e){try{var t=void 0;if("Create"===e.Type){var r=Utils.getSharedGroupData(Helpers.getGamesListId(e.UserId)),a=0;for(var n in r)r.hasOwnProperty(n)&&Helpers.getCreatorId(n)===e.UserId&&!Utils.undefinedOrNull(r[n])&&r[n].s>=GameStates.UnmatchedPlaying&&r[n].s<=GameStates.Blocked&&a++;return a>maxGamesPerPlayer?{ResultCode:WebErrors.MaxGamesReached,Message:"Maximum allowed games exceeded!"}:{ResultCode:WebErrors.Success,Message:"OK"}}if("Load"===e.Type){if(t=Helpers.loadGameData(e.GameId),Utils.undefinedOrNull(t)||Utils.undefinedOrNull(t.State))throw new PhotonException(WebErrors.GameNotFound,"Room State="+e.GameId+" not found",{Webhook:e,CustomState:t});return{ResultCode:WebErrors.Success,Message:"OK",State:t.State}}throw new PhotonException(WebErrors.UnexpectedValue,"Wrong PathCreate Type="+e.Type,{
Webhook:e})}catch(t){return t instanceof PhotonException?{ResultCode:t.resultCode,Message:t.message}:(Utils.logException("RoomCreated",{e:t,args:e}),{ResultCode:WebErrors.UnknownError,Message:JSON.stringify(t,Utils.replaceErrors)})}},handlers.RoomClosed=function(e){try{if("Close"===e.Type)Utils.logException(e,"Unexpected GameClose, Type == Close");else{if("Save"!==e.Type)throw new PhotonException(WebErrors.UnexpectedValue,"Wrong PathClose Type="+e.Type,{Webhook:e});var t=Helpers.loadGameData(e.GameId);if(Utils.undefinedOrNull(t))throw new PhotonException(WebErrors.GameNotFound,"Room State save error: game not found",{Webhook:e});if(e.State.ActorList.length!==t.a.length&&t.gt!==GameTypes.Challenge)throw new PhotonException(WebErrors.UnexpectedValue,"Room State save error: State.ActorList.length != a.length",t);t.State=Helpers.stripRoomState(e.State),Helpers.saveGameData(e.GameId,t)}return{ResultCode:WebErrors.Success,Message:"OK"}}catch(t){return t instanceof PhotonException?{ResultCode:t.resultCode,Message:t.message}:(Utils.logException("RoomClosed",{e:t,args:e}),{ResultCode:WebErrors.UnknownError,Message:JSON.stringify(t,Utils.replaceErrors)})}},handlers.RoomLeft=function(e){try{if(unexpectedLeaveReasons.indexOf(e.Reason)>-1)throw new PhotonException(WebErrors.UnexpectedValue,"Unexpected LeaveReason",e);if(e.IsInactive===!1&&e.Reason!==leaveReason.LeaveRequest)throw new PhotonException(WebErrors.UnexpectedValue,"Unexpected IsInactive flag",e);return{ResultCode:WebErrors.Success,Message:"OK"}}catch(t){return t instanceof PhotonException?{ResultCode:t.resultCode,Message:t.message}:(Utils.logException("RoomLeft",{e:t,args:e}),{ResultCode:WebErrors.UnknownError,Message:JSON.stringify(t,Utils.replaceErrors)})}},handlers.RoomEventRaised=function(e){try{var t=void 0;return e.EvCode>CustomEventCodes.InitGame&&(t=Helpers.loadGameData(e.GameId)),t=GameLogic.onEventReceived(e,t),Utils.undefinedOrNull(e.State)||delete t.State,Helpers.saveGameData(e.GameId,t),{ResultCode:WebErrors.Success,Message:"OK"}}catch(t){if(t instanceof PhotonException){if(t.resultCode===WebErrors.EventFailure)switch(e.EvCode){case CustomEventCodes.EndOfRound:return{ResultCode:t.resultCode,Message:e.EvCode+","+e.Data.r.r+","+t.message};case CustomEventCodes.NewRound:return{ResultCode:t.resultCode,Message:e.EvCode+","+e.Data.r+","+t.message};case CustomEventCodes.EndOfGame:case CustomEventCodes.EndOfTurn:return{ResultCode:t.resultCode,Message:e.EvCode+","+e.Data.t+","+t.message};case CustomEventCodes.WordukenUsed:return{ResultCode:t.resultCode,Message:e.EvCode+","+e.Data.wi+","+t.message};default:return{ResultCode:t.resultCode,Message:e.EvCode+","+t.message}}return{ResultCode:t.resultCode,Message:t.message}}return Utils.logException("RoomEventRaised",{e:t,args:e}),{ResultCode:WebErrors.UnknownError,Message:JSON.stringify(t,Utils.replaceErrors)}}},handlers.RoomJoined=function(e){try{if(e.ActorNr<0||e.ActorNr>2)throw new PhotonException(WebErrors.UnexpectedValue,"ActorNr < 0 || ActorNr > 2",e);return{ResultCode:WebErrors.Success,Message:"OK"}}catch(t){return t instanceof PhotonException?{ResultCode:t.resultCode,Message:t.message}:(Utils.logException("RoomJoined",{e:t,args:e}),{ResultCode:WebErrors.UnknownError,Message:JSON.stringify(t,Utils.replaceErrors)})}};var Utils=function(){function e(){}return e.undefinedOrNull=function(e){return void 0===e||null===e},e.isEmpty=function(t){return e.undefinedOrNull(t)||0===Object.getOwnPropertyNames(t).length},e.isString=function(e){return"string"==typeof e||e instanceof String},e.getISOTimestamp=function(){return(new Date).toISOString()+Math.random()},e.replaceErrors=function(e,t){if(t instanceof Error){var r={};return Object.getOwnPropertyNames(t).forEach(function(e){return r[e]=t[e]}),r}return t},e.logException=function(t,r,a){e.undefinedOrNull(a)&&(a=e.getISOTimestamp()),http.request("http://logs-01.loggly.com/inputs/47d0eb9f-eb72-49a3-8921-730df6ea180c/tag/PlayFab/","post",JSON.stringify({ts:a,msg:t,d:r},e.replaceErrors),"application/json")},e.createSharedGroup=function(e){try{server.CreateSharedGroup({SharedGroupId:e})}catch(e){throw e}},e.updateSharedGroupData=function(t,r){var a,n={};try{var s=void 0;if(Object.keys(r).length<=maxSharedGroupKeysPerUpdate){for(s in r)r.hasOwnProperty(s)&&(e.undefinedOrNull(r[s])?n[s]=r[s]:n[s]=JSON.stringify(r[s]));a=server.UpdateSharedGroupData({SharedGroupId:t,Data:n})}else{var o=0;for(s in r)r.hasOwnProperty(s)&&(e.undefinedOrNull(r[s])?n[s]=r[s]:n[s]=JSON.stringify(r[s]),o++,o===maxSharedGroupKeysPerUpdate&&(a=server.UpdateSharedGroupData({SharedGroupId:t,Data:n}),o=0,n={}));o>0&&(a=server.UpdateSharedGroupData({SharedGroupId:t,Data:n}))}}catch(r){throw e.logException("updateSharedGroupData("+t+", "+JSON.stringify(n)+")",{ret:a,err:r}),r}},e.getSharedGroupData=function(t,r){var a={};try{a=e.undefinedOrNull(r)?server.GetSharedGroupData({SharedGroupId:t}).Data:server.GetSharedGroupData({SharedGroupId:t,Keys:r}).Data;var n=void 0;for(n in a)a.hasOwnProperty(n)&&(a[n]=JSON.parse(a[n].Value));return a}catch(n){if(!e.undefinedOrNull(n.Error)&&"InvalidSharedGroupId"===n.Error.error&&t===Helpers.getGamesListId(currentPlayerId))return e.logException("sharedGroup "+t+" not found, creating it"),e.createSharedGroup(t),{};throw e.logException("getSharedGroupData:"+t+","+JSON.stringify(r),{ret:a,err:n}),n}},e.deleteSharedGroup=function(t){var r;try{return r=server.DeleteSharedGroup({SharedGroupId:t})}catch(a){throw e.logException("deleteSharedGroup:"+t,{err:a,ret:r}),a}},e.getSharedGroupEntry=function(t,r){var a;try{return a=e.getSharedGroupData(t,[r])[r]}catch(n){throw e.logException("getSharedGroupEntry:"+t+","+r,{err:n,ret:a}),n}},e.updateSharedGroupEntry=function(t,r,a){try{var n={};return n[r]=a,e.updateSharedGroupData(t,n)}catch(n){throw e.logException("updateSharedGroupEntry:"+t+","+r+","+a,n),n}},e.deleteSharedGroupEntry=function(t,r){try{return e.updateSharedGroupEntry(t,r,null)}catch(a){throw e.logException("deleteSharedGroupEntry:"+t+","+r,a),a}},e.getUserInventory=function(t){var r=null;try{return r=server.GetUserInventory({PlayFabId:t}),r.Inventory}catch(a){throw e.logException("Error getting inventory for "+t,{err:a,ret:r}),a}},e.consumeItem=function(t,r,a){var n;try{return n=server.ConsumeItem({PlayFabId:t,ItemInstanceId:r,ConsumeCount:a})}catch(s){throw e.logException("Error consuming ("+a+") "+r+" for "+t,{err:s,ret:n}),s}},e.grantItemsToUser=function(t,r){var a;try{return a=server.GrantItemsToUser({PlayFabId:t,ItemIds:r})}catch(n){throw e.logException("grantItemsToUser error adding ",{err:n,ret:a,u:t,i:r}),n}},e.getPlayerCombinedInfo=function(t){var r;try{return r=server.GetPlayerCombinedInfo({PlayFabId:t,InfoRequestParameters:{GetUserAccountInfo:!0,GetUserInventory:!0,GetUserVirtualCurrency:!0,GetUserData:!0,GetUserReadOnlyData:!0,GetPlayerStatistics:!0,GetCharacterInventories:!1,GetCharacterList:!1,GetTitleData:!1}}),r.InfoResultPayload}catch(a){throw e.logException("getPlayerCombinedInfo error ",{err:a,ret:r,u:t}),a}},e.updatePlayerStats=function(t,r){var a;try{return a=server.UpdatePlayerStatistics({PlayFabId:t,Statistics:r})}catch(n){throw e.logException("updatePlayerStats error ",{err:n,ret:a,u:t,s:r}),n}},e.updateUserReadOnlyData=function(t,r){var a;try{return a=server.UpdateUserReadOnlyData({PlayFabId:t,Data:r,Permission:"Public"})}catch(n){throw e.logException("updateUserReadOnlyData error ",{err:n,ret:a,u:t,d:r}),n}},e}();